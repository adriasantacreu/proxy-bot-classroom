<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Proxy Classroom Tester (Full API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* JSON Highlighting - Dynamic Colors */
        .json-key {
            color: var(--json-key);
        }

        .json-string {
            color: var(--json-string);
        }

        .json-number {
            color: var(--json-number);
        }

        .json-boolean {
            color: var(--json-boolean);
        }

        .json-null {
            color: var(--json-null);
        }

        :root {
            --json-key: #4f46e5;
            --json-string: #059669;
            --json-number: #d97706;
            --json-boolean: #2563eb;
            --json-null: #64748b;
        }

        .dark {
            --json-key: #a5b4fc;
            --json-string: #86efac;
            --json-number: #fde047;
            --json-boolean: #60a5fa;
            --json-null: #475569;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #334155;
        }
    </style>
</head>

<body
    class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen p-4 lg:p-8 transition-colors duration-300"
    id="body">

    <div class="max-w-7xl mx-auto flex flex-col gap-6">
        <!-- HEADER / THEME SWITCHER -->
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-2xl font-black bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                Proxy Bot v2.2
            </h1>
            <button onclick="toggleTheme()" id="themeBtn"
                class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 p-2 rounded-xl shadow-sm hover:shadow-md transition">
                <span id="themeIcon">üåô</span>
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- PANEL CONTROL (IZQUIERDA) -->
            <div class="lg:col-span-4 space-y-4">

                <div
                    class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm transition-colors text-center lg:text-left">
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 mb-4 leading-relaxed italic">
                        <b>üìç Prova-ho en viu:</b> Inscriu-te com a alumne per veure com apareixen les tasques i anuncis
                        en temps real (pots sortir del curs quan vulguis).
                    </p>
                    <div class="flex flex-col gap-2">
                        <a href="https://classroom.google.com/c/ODQ0MjAwMTkwMjc3?cjc=vecw3hbq" target="_blank"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 text-xs shadow-lg shadow-indigo-500/20 group">
                            <span>üë®‚Äçüéì</span> Join Demo Class (vecw3hbq)
                        </a>
                    </div>
                </div>

                <!-- CONFIG -->
                <div
                    class="bg-white dark:bg-slate-900/50 p-5 rounded-2xl border border-slate-200 dark:border-slate-800 transition-colors">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider">
                            Connexi√≥</h2>
                        <span id="connectionStatus" class="text-[10px] text-slate-500">üî¥ Offline</span>
                    </div>
                    <div class="space-y-3">
                        <input type="text" id="apiUrl"
                            value="https://script.google.com/macros/s/AKfycbzPfy44tc7DaNMzv6uMledJsHsCGIBKdeMh-7QpUEOHE893jB4dTDhN33lsgurkE1PriQ/exec"
                            class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 text-[10px] font-mono text-slate-800 dark:text-slate-200">
                        <div class="relative">
                            <input type="password" id="apiKey" value="pk_classroom_T9xR4mLw2vQ7nBs5jK8yF3hU6dP1aZ0c"
                                autocomplete="off"
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 text-[10px] font-mono pr-10 text-slate-800 dark:text-slate-200">
                            <button onclick="toggleKey()"
                                class="absolute right-3 top-2 text-slate-400 hover:text-slate-600">üëÅÔ∏è</button>
                        </div>
                        <button onclick="checkConnectionAndLoadCourses()"
                            class="w-full bg-slate-800 dark:bg-slate-700 hover:bg-slate-700 dark:hover:bg-slate-600 text-white py-2 rounded-lg text-[10px] font-bold transition border border-slate-700">
                            üîÑ LOAD SETTINGS
                        </button>
                    </div>
                </div>

                <!-- LOG -->
                <div
                    class="bg-white dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-200 dark:border-slate-800 max-h-48 overflow-y-auto transition-colors">
                    <h2 class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-2">
                        History</h2>
                    <ul id="historyList" class="space-y-1 text-[10px] font-mono text-slate-500 dark:text-slate-400">
                    </ul>
                </div>
            </div>

            <!-- PANEL ACCIONS (DERECHA) -->
            <div class="lg:col-span-8 flex flex-col gap-6">

                <div
                    class="bg-white dark:bg-slate-900 p-6 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-sm transition-colors">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-sm font-bold text-blue-600 dark:text-blue-400 uppercase tracking-wider">‚ö° API
                            Operation Builder</h2>
                        <span id="callType"
                            class="text-[9px] bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-2 py-1 rounded">SELECT
                            ACTION</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <!-- Selector -->
                        <div class="md:col-span-12">
                            <select id="actionSelect"
                                class="w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-800 dark:text-slate-200 focus:border-blue-500 focus:outline-none">
                                <option value="" disabled selected>-- Tria una acci√≥ --</option>
                                <optgroup label="üìä LECTURA (GET)">
                                    <option value="list_courses">Llistar Cursos</option>
                                    <option value="list_students">Llistar Alumnes</option>
                                    <option value="list_teachers">Llistar Professors</option>
                                    <option value="list_courseWork">Llistar Tasques</option>
                                    <option value="list_submissions">Llistar Entregues i Notes</option>
                                    <option value="list_announcements">Llistar Anuncis</option>
                                    <option value="list_materials">Llistar Materials</option>
                                    <option value="list_topics">Llistar Temes</option>
                                </optgroup>
                                <optgroup label="‚úèÔ∏è CREACI√ì (POST)">
                                    <option value="create_courseWork">Crear Tasca (+Adjunts)</option>
                                    <option value="create_announcement">Publicar Anunci</option>
                                    <option value="create_material">Enviar Material</option>
                                    <option value="invite_student">Invitar Alumne (Email)</option>
                                    <option value="invite_teacher">Invitar Professor (Email)</option>
                                    <option value="create_topic">Crear Tema</option>
                                </optgroup>
                                <optgroup label="‚úÖ AVALUACI√ì (POST)">
                                    <option value="grade_submission">Qualificar Entrega</option>
                                    <option value="return_submission">Retornar Tasca</option>
                                </optgroup>
                                <optgroup label="‚öôÔ∏è ADMINISTRACI√ì (DANGEROUS)">
                                    <option value="create_course">Crear Curs</option>
                                    <option value="delete_courseWork">Eliminar Tasca</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Params Form -->
                        <div id="dynamicForm"
                            class="md:col-span-12 grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-slate-100 dark:border-slate-800 pt-4 hidden">
                            <!-- Generat per JS -->
                        </div>
                    </div>

                    <div class="flex justify-end mt-6">
                        <button onclick="executeAction()" id="btnRun"
                            class="bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white font-black py-3 px-10 rounded-xl shadow-lg transition transform active:scale-95">
                            RUN REQUEST
                        </button>
                    </div>
                </div>

                <!-- RESULTATS -->
                <div
                    class="flex-1 bg-white dark:bg-slate-950 rounded-2xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden relative min-h-[400px] transition-colors">
                    <div
                        class="bg-slate-50 dark:bg-slate-900/80 px-4 py-2 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center transition-colors">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-mono text-slate-400 uppercase">Output Console</span>
                            <div class="group relative">
                                <span
                                    class="cursor-help text-[10px] bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 px-1.5 rounded-full font-bold">?</span>
                                <div
                                    class="absolute left-0 top-6 w-64 p-3 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl text-[11px] text-slate-600 dark:text-slate-300 hidden group-hover:block z-50 leading-normal">
                                    <p class="font-bold mb-1 text-blue-600 dark:text-blue-400">Qu√® √©s aquest codi? ü§î
                                    </p>
                                    Aquest text (JSON) √©s el <b>"rebut digital"</b> que ens envia Google. Confirma que
                                    l'acci√≥ s'ha fet correctament i cont√© tota la informaci√≥ t√®cnica del que s'acaba de
                                    crear o llegir. Si hi ha un error, tamb√© t'ho explicar√† aqu√≠ amb detalls per a
                                    inform√†tics.
                                </div>
                            </div>
                        </div>
                        <span id="statusBadge" class="hidden text-[10px] font-bold px-2 py-0.5 rounded">READY</span>
                    </div>
                    <!-- RAW URL DISPLAY -->
                    <div id="urlDisplay"
                        class="bg-slate-100 dark:bg-slate-900 px-6 py-3 border-b border-slate-200 dark:border-slate-800 hidden transition-colors">
                        <div class="flex flex-col gap-1">
                            <span class="text-[9px] font-bold text-blue-600 dark:text-blue-400 uppercase">HTTP GET/POST
                                URL (RAW)</span>
                            <div class="text-[10px] font-mono text-slate-500 dark:text-slate-400 break-all select-all selection:bg-blue-500 selection:text-white"
                                id="rawUrlContent"></div>
                        </div>
                    </div>
                    <div id="loader"
                        class="hidden absolute inset-0 bg-white/80 dark:bg-slate-950/80 backdrop-blur-[2px] flex items-center justify-center z-10 font-mono text-xs text-blue-600 dark:text-blue-500 transition-colors">
                        <span class="animate-pulse">PETITION IN PROGRESS...</span>
                    </div>
                    <div class="flex-1 overflow-auto p-6 font-mono text-xs leading-relaxed whitespace-pre bg-white dark:bg-slate-950 transition-colors"
                        id="jsonOutput">
                        <span class="text-slate-300 dark:text-slate-800">// No result yet.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let AVAILABLE_COURSES = [];
        let CACHE_ASSIGNMENTS = {}; // courseId -> assignments[]
        let CACHE_SUBMISSIONS = {}; // assignmentId -> submissions[]
        let CACHE_STUDENTS = {};    // courseId -> { userId: name }

        const formContainer = document.getElementById('dynamicForm');
        const output = document.getElementById('jsonOutput');
        const statusBadge = document.getElementById('statusBadge');
        const loader = document.getElementById('loader');
        const historyList = document.getElementById('historyList');
        const connectionStatus = document.getElementById('connectionStatus');

        // MAPA COMPLET D'ACCIONS I PAR√ÄMETRES
        const SCHEMAS = {
            list_courses: [],
            list_students: [{ id: 'courseId', label: 'Curs', type: 'courseSelect', req: true }],
            list_teachers: [{ id: 'courseId', label: 'Curs', type: 'courseSelect', req: true }],
            list_courseWork: [{ id: 'courseId', label: 'Curs', type: 'courseSelect', req: true }],
            list_announcements: [{ id: 'courseId', label: 'Curs', type: 'courseSelect', req: true }],
            list_materials: [{ id: 'courseId', label: 'Curs', type: 'courseSelect', req: true }],
            list_topics: [{ id: 'courseId', label: 'Curs', type: 'courseSelect', req: true }],
            list_submissions: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'courseWorkId', label: 'Tasca (Auto-load)', type: 'assignmentSelect', req: true }
            ],
            create_courseWork: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'title', label: 'T√≠tol', type: 'text', placeholder: 'Nova Tasca', req: true },
                { id: 'description', label: 'Instruccions', type: 'text' },
                { id: 'materials', label: 'Adjunts (JSON)', type: 'textarea', isJson: true }
            ],
            create_announcement: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'text', label: 'Text del missatge', type: 'textarea', req: true }
            ],
            invite_student: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'email', label: 'Email alumne', type: 'email', req: true }
            ],
            invite_teacher: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'email', label: 'Email professor', type: 'email', req: true }
            ],
            create_material: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'title', label: 'T√≠tol', type: 'text', placeholder: 'Material de lectura', req: true },
                { id: 'description', label: 'Descripci√≥', type: 'textarea' },
                { id: 'materials', label: 'Adjunts (JSON)', type: 'textarea', isJson: true }
            ],
            grade_submission: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'courseWorkId', label: 'Tasca', type: 'assignmentSelect', req: true },
                { id: 'id', label: 'Entrega (Alumne)', type: 'submissionSelect', req: true },
                { id: 'grade', label: 'Nota', type: 'number', placeholder: '9.5' }
            ],
            return_submission: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'courseWorkId', label: 'Tasca', type: 'assignmentSelect', req: true },
                { id: 'id', label: 'Entrega (Alumne)', type: 'submissionSelect', req: true }
            ],
            create_topic: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'name', label: 'Nom del Tema', type: 'text', req: true }
            ],
            create_course: [
                { id: 'name', label: 'Nom del Curs', type: 'text', req: true },
                { id: 'section', label: 'Secci√≥', type: 'text' },
                { id: 'descriptionHeading', label: 'Cap√ßalera', type: 'text' }
            ],
            delete_courseWork: [
                { id: 'courseId', label: 'Curs', type: 'courseSelect', req: true },
                { id: 'id', label: 'Tasca', type: 'assignmentSelect', req: true }
            ]
        };

        const EXAMPLE_MATERIALS = JSON.stringify([
            { "link": { "url": "https://google.com", "title": "Google Search" } },
            { "youtubeVideo": { "id": "dQw4w9WgXcQ", "title": "Never Give Up" } }
        ], null, 2);

        function toggleTheme() {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            document.getElementById('themeIcon').innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Init theme
        if (localStorage.getItem('theme') === 'dark') {
            document.documentElement.classList.add('dark');
            document.getElementById('themeIcon').innerText = '‚òÄÔ∏è';
        }

        function toggleKey() {
            const i = document.getElementById('apiKey');
            i.type = i.type === 'password' ? 'text' : 'password';
        }

        async function fetchHelper(action, params = {}) {
            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;
            const query = new URLSearchParams({ action, key, ...params });
            const response = await fetch(`${url}?${query.toString()}`, { method: 'GET', credentials: 'omit' });
            return await response.json();
        }

        async function checkConnectionAndLoadCourses() {
            connectionStatus.innerHTML = '<span class="text-yellow-600 dark:text-yellow-500 animate-pulse">üü° Syncing...</span>';
            try {
                const json = await fetchHelper('list_courses');
                if (Array.isArray(json)) {
                    AVAILABLE_COURSES = json;
                    connectionStatus.innerHTML = `<span class="text-green-600 dark:text-green-400">üü¢ Connected ‚Ä¢ ${json.length} curs(os)</span>`;
                    logHistory('System', 'Courses loaded');
                    document.getElementById('actionSelect').value = "";
                    formContainer.classList.add('hidden');
                } else { throw new Error(json.error || "Bad Response"); }
            } catch (e) {
                connectionStatus.innerHTML = `<span class="text-red-500">üî¥ Error: ${e.message}</span>`;
            }
        }

        async function updateAssignmentsDropdown(courseId, selectElement) {
            selectElement.innerHTML = '<option disabled selected>Loading tasks...</option>';
            try {
                if (!CACHE_ASSIGNMENTS[courseId]) {
                    const data = await fetchHelper('list_courseWork', { courseId });
                    CACHE_ASSIGNMENTS[courseId] = Array.isArray(data) ? data : [];
                }
                const tasks = CACHE_ASSIGNMENTS[courseId];
                selectElement.innerHTML = tasks.length ? '' : '<option disabled>No tasks found</option>';
                tasks.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.innerText = t.title || t.id;
                    selectElement.appendChild(opt);
                });
                selectElement.dispatchEvent(new Event('change'));
            } catch (e) {
                selectElement.innerHTML = '<option disabled>Error loading tasks</option>';
            }
        }

        async function updateSubmissionsDropdown(courseId, courseWorkId, selectElement) {
            selectElement.innerHTML = '<option disabled selected>Loading students...</option>';
            try {
                if (!CACHE_STUDENTS[courseId]) {
                    const studentData = await fetchHelper('list_students', { courseId });
                    const map = {};
                    if (Array.isArray(studentData)) {
                        studentData.forEach(s => {
                            map[s.userId] = s.profile?.name?.fullName || s.userId;
                        });
                    }
                    CACHE_STUDENTS[courseId] = map;
                }

                const cacheKey = `${courseId}_${courseWorkId}`;
                if (!CACHE_SUBMISSIONS[cacheKey]) {
                    const data = await fetchHelper('list_submissions', { courseId, courseWorkId });
                    CACHE_SUBMISSIONS[cacheKey] = Array.isArray(data) ? data : [];
                }

                const subs = CACHE_SUBMISSIONS[cacheKey];
                const studentMap = CACHE_STUDENTS[courseId];

                selectElement.innerHTML = subs.length ? '' : '<option disabled>No submissions</option>';
                subs.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    const name = studentMap[s.userId] || s.userId;
                    opt.innerText = `${name} (Score: ${s.draftGrade || s.assignedGrade || 'N/A'})`;
                    selectElement.appendChild(opt);
                });
            } catch (e) {
                selectElement.innerHTML = '<option disabled>Error loading</option>';
            }
        }

        document.getElementById('actionSelect').addEventListener('change', (e) => {
            const action = e.target.value;
            const fields = SCHEMAS[action] || [];
            formContainer.innerHTML = '';
            formContainer.classList.remove('hidden');

            fields.forEach(field => {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.className = "block text-[10px] text-slate-400 dark:text-slate-500 mb-1 uppercase font-bold";
                label.innerText = field.req ? `${field.label} *` : field.label;

                if (field.isJson) {
                    const b = document.createElement('button');
                    b.innerText = " (template)";
                    b.className = "text-blue-600 dark:text-blue-500 underline ml-2 hover:text-blue-500 dark:hover:text-blue-400";
                    b.onclick = (ev) => { ev.preventDefault(); input.value = EXAMPLE_MATERIALS; };
                    const f = document.createElement('button');
                    f.innerText = " (auto-format)";
                    f.className = "text-green-600 dark:text-green-500 underline ml-2 hover:text-green-500 dark:hover:text-green-400";
                    f.onclick = (ev) => {
                        ev.preventDefault();
                        try { input.value = JSON.stringify(JSON.parse(input.value), null, 4); } catch (e) { alert("JSON inv√†lid!"); }
                    };
                    label.appendChild(b);
                    label.appendChild(f);
                }

                let input;
                if (field.type === 'courseSelect') {
                    input = document.createElement('select');
                    input.className = "w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 text-xs text-slate-800 dark:text-white type-courseSelect";
                    AVAILABLE_COURSES.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.innerText = `${c.name} (${c.section || 'No Sect'})`;
                        input.appendChild(opt);
                    });
                    input.addEventListener('change', () => {
                        const assSelect = formContainer.querySelector('.type-assignmentSelect');
                        if (assSelect) updateAssignmentsDropdown(input.value, assSelect);
                    });
                } else if (field.type === 'assignmentSelect') {
                    input = document.createElement('select');
                    input.className = "w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 text-xs text-slate-800 dark:text-white type-assignmentSelect";
                    input.addEventListener('change', () => {
                        const subSelect = formContainer.querySelector('.type-submissionSelect');
                        const courseId = formContainer.querySelector('.type-courseSelect')?.value;
                        if (subSelect && courseId) updateSubmissionsDropdown(courseId, input.value, subSelect);
                    });
                } else if (field.type === 'submissionSelect') {
                    input = document.createElement('select');
                    input.className = "w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 text-xs text-slate-800 dark:text-white type-submissionSelect";
                } else if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                    input.className = "w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 text-xs text-slate-800 dark:text-white font-mono";
                } else {
                    input = document.createElement('input');
                    input.type = field.type;
                    input.className = "w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg px-3 py-2 text-xs text-slate-800 dark:text-white";
                }

                input.id = `input-${field.id}`;
                input.placeholder = field.placeholder || '';
                div.appendChild(label);
                div.appendChild(input);
                formContainer.appendChild(div);

                if (field.type === 'courseSelect') {
                    setTimeout(() => input.dispatchEvent(new Event('change')), 100);
                }
            });
        });

        async function executeAction() {
            const action = document.getElementById('actionSelect').value;
            if (!action) return;
            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;

            const payload = { action, key };
            const queryParams = new URLSearchParams({ action, key });

            formContainer.querySelectorAll('input, textarea, select').forEach(i => {
                const k = i.id.replace('input-', '');
                let v = i.value;
                if (i.tagName === 'TEXTAREA' && v.trim().startsWith('[')) {
                    try { v = JSON.parse(v); } catch (e) { }
                }
                payload[k] = v;
                if (typeof v !== 'object') queryParams.append(k, v);
            });

            const fullUrl = `${url}?${queryParams.toString()}`;
            document.getElementById('urlDisplay').classList.remove('hidden');
            document.getElementById('rawUrlContent').innerText = fullUrl;

            loader.classList.remove('hidden');
            output.innerHTML = '';
            statusBadge.classList.add('hidden');
            document.getElementById('btnCopy')?.remove();

            try {
                const response = await fetch(`${url}?${queryParams.toString()}`, {
                    method: 'POST',
                    credentials: 'omit',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                const json = await response.json();
                loader.classList.add('hidden');

                const formatted = JSON.stringify(json, null, 4);
                output.innerHTML = syntaxHighlight(formatted);

                const link = json.alternateLink || (json.course && json.course.alternateLink);
                if (link) {
                    const btnLink = document.createElement('a');
                    btnLink.href = link;
                    btnLink.target = "_blank";
                    btnLink.className = "inline-flex items-center gap-2 bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-4 py-2 rounded-xl mb-4 transition shadow-lg shadow-green-500/20";
                    btnLink.innerHTML = "<span>üîó</span> Obrir al Classroom";
                    output.prepend(btnLink);
                }

                const btnCopy = document.createElement('button');
                btnCopy.id = "btnCopy";
                btnCopy.className = "absolute top-12 right-6 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 text-[10px] px-2 py-1 rounded border border-slate-200 dark:border-slate-700 transition";
                btnCopy.innerText = "üìã Copy JSON";
                btnCopy.onclick = () => {
                    navigator.clipboard.writeText(formatted);
                    btnCopy.innerText = "‚úÖ Copied!";
                    setTimeout(() => btnCopy.innerText = "üìã Copy JSON", 2000);
                };
                output.parentElement.appendChild(btnCopy);

                const isErr = json.error || (json.code && json.code >= 400);
                statusBadge.innerText = isErr ? 'ERROR' : 'SUCCESS';
                statusBadge.className = `text-[10px] font-bold px-2 py-0.5 rounded ${isErr ? 'bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-100' : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-100'}`;
                statusBadge.classList.remove('hidden');
                logHistory(action, isErr ? 'Failed' : 'Success', isErr);
            } catch (err) {
                loader.classList.add('hidden');
                output.innerText = "// NETWORK ERROR: Check Google Script permissions / Anyone settings.";
                logHistory(action, 'Network Error', true);
            }
        }

        function logHistory(action, status, isError) {
            const li = document.createElement('li');
            li.innerHTML = `<span class="text-slate-400 uppercase">[${new Date().toLocaleTimeString()}]</span> <span class="${isError ? 'text-red-500' : 'text-blue-600 dark:text-blue-400'}">${action}</span>`;
            historyList.prepend(li);
        }

        function syntaxHighlight(json) {
            if (typeof json != 'string') json = JSON.stringify(json, undefined, 4);
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return `<span class="${cls}">${match}</span>`;
            });
        }
    </script>
</body>

</html>