<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Proxy Classroom Tester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .json-key {
            color: #a5b4fc;
        }

        .json-string {
            color: #86efac;
        }

        .json-number {
            color: #fca5a5;
        }

        .json-boolean {
            color: #f9a8d4;
        }

        /* Scrollbar custom */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen p-4 lg:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">

        <!-- PANEL ESQUERRE: CONTROL (4 cols) -->
        <div class="lg:col-span-4 space-y-6">

            <!-- CAP√áALERA -->
            <div class="bg-slate-900 p-5 rounded-2xl border border-slate-800 shadow-xl">
                <h1
                    class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">
                    Proxy Bot Tester
                </h1>
                <p class="text-slate-400 text-sm mt-1 mb-4">Google Classroom API Proxy</p>

                <div class="flex flex-col gap-2">
                    <a href="https://classroom.google.com/c/ODQ0MjAwMTkwMjc3?cjc=vecw3hbq" target="_blank"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2 text-sm shadow-lg shadow-indigo-500/20 group">
                        <span>üë®‚Äçüéì</span>
                        <div>
                            <span class="block">Join Demo Class as Student</span>
                            <span class="text-[10px] font-normal opacity-80 group-hover:opacity-100">Code: vecw3hbq
                                (Auto-Join)</span>
                        </div>
                    </a>
                </div>
            </div>

            <!-- CONFIGURACI√ì -->
            <div class="bg-slate-900/50 p-5 rounded-2xl border border-slate-800">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Configuraci√≥ API</h2>
                    <span id="connectionStatus" class="text-[10px] text-slate-500 flex items-center gap-1">üî¥
                        Disconnected</span>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase">Script URL</label>
                        <input type="text" id="apiUrl"
                            value="https://script.google.com/macros/s/AKfycbzPfy44tc7DaNMzv6uMledJsHsCGIBKdeMh-7QpUEOHE893jB4dTDhN33lsgurkE1PriQ/exec"
                            class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:border-blue-500 focus:outline-none transition font-mono text-slate-300">
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase">API Key</label>
                        <input type="password" id="apiKey" value="pk_classroom_T9xR4mLw2vQ7nBs5jK8yF3hU6dP1aZ0c"
                            class="w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-xs focus:border-blue-500 focus:outline-none transition font-mono text-slate-300">
                    </div>
                    <button onclick="checkConnectionAndLoadCourses()"
                        class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 py-2 rounded-lg text-xs font-medium border border-slate-700 transition">
                        üîÑ Test Connection & Load Courses
                    </button>
                </div>
            </div>

            <!-- HISTORY -->
            <div class="bg-slate-900/50 p-4 rounded-2xl border border-slate-800 flex-1 min-h-[200px]">
                <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Activity Log</h2>
                <ul id="historyList" class="space-y-2 text-xs font-mono text-slate-400 overflow-y-auto max-h-[300px]">
                    <li class="opacity-50 italic">Ready to start...</li>
                </ul>
            </div>
        </div>

        <!-- PANEL DRET: ACCIONS I RESULTATS (8 cols) -->
        <div class="lg:col-span-8 flex flex-col gap-6">

            <!-- ACCI√ì BUILDER -->
            <div class="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl -z-0"></div>

                <h2 class="text-sm font-bold text-blue-400 uppercase tracking-wider mb-4 flex items-center gap-2">
                    <span>‚ö°</span> Action Builder
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="md:col-span-1">
                        <label class="block text-xs text-slate-400 mb-1.5 ml-1">Select Action</label>
                        <select id="actionSelect"
                            class="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500 focus:outline-none appearance-none cursor-pointer hover:border-slate-600 transition">
                            <option value="" disabled selected>-- Choose Function --</option>
                            <optgroup label="üîç GET (Read-Only)">
                                <option value="list_courses">List Courses</option>
                                <option value="list_courseWork">List Assignments</option>
                                <option value="list_students">List Students</option>
                            </optgroup>
                            <optgroup label="‚ú® POST (Creation)">
                                <option value="create_courseWork">Create Full Assignment üíé</option>
                                <option value="create_announcement">Post Announcement</option>
                                <option value="create_material">Create Material</option>
                                <option value="create_course" class="text-yellow-200">Create New Course</option>
                                <option value="invite_student">Invite Student</option>
                            </optgroup>
                            <optgroup label="‚úèÔ∏è PATCH (Update)">
                                <option value="patch_courseWork">Update Assignment</option>
                            </optgroup>
                            <optgroup label="üóëÔ∏è DELETE (Danger)">
                                <option value="delete_courseWork">Delete Assignment</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- FORMULARI DIN√ÄMIC -->
                    <div id="dynamicForm" class="md:col-span-2 grid grid-cols-1 gap-3">
                        <div class="text-slate-500 text-sm flex items-center h-full italic pl-2">
                            Select an action to configure parameters...
                        </div>
                    </div>
                </div>

                <div class="flex justify-end pt-4 border-t border-slate-800/50">
                    <button onclick="executeAction()"
                        class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 px-8 rounded-xl shadow-lg shadow-blue-900/20 hover:shadow-blue-500/30 transition flex items-center gap-2 transform active:scale-95">
                        <span>‚ñ∂</span> Run Request
                    </button>
                </div>
            </div>

            <!-- RESULTATS -->
            <div
                class="flex-1 bg-slate-950 rounded-2xl border border-slate-800 shadow-inner flex flex-col overflow-hidden relative group min-h-[400px]">
                <div
                    class="bg-slate-900/80 backdrop-blur px-4 py-3 border-b border-slate-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-mono text-slate-400 uppercase">Response Output</span>
                        <!-- Status Badge -->
                        <span id="statusBadge"
                            class="hidden text-[10px] font-bold px-2 py-0.5 rounded bg-slate-800 text-slate-400">WAITING</span>
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div id="loader"
                    class="hidden absolute inset-0 bg-slate-950/80 backdrop-blur-[2px] flex flex-col items-center justify-center z-10 transition-all">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500 mb-3"></div>
                    <span class="text-xs text-blue-400 font-mono animate-pulse">Processing Request...</span>
                </div>

                <div class="flex-1 overflow-auto p-6 font-mono text-xs leading-relaxed" id="jsonOutput">
                    <span class="text-slate-600">// JSON response will appear here...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // ESTAT GLOBAL
        let AVAILABLE_COURSES = []; // Per omplir el selector de ID

        // DOM ELEMENTS
        const formContainer = document.getElementById('dynamicForm');
        const output = document.getElementById('jsonOutput');
        const statusBadge = document.getElementById('statusBadge');
        const loader = document.getElementById('loader');
        const historyList = document.getElementById('historyList');
        const connectionStatus = document.getElementById('connectionStatus');

        // SCHEMAS DEFINITION
        const SCHEMAS = {
            create_course: [
                { id: 'name', label: 'Course Name', type: 'text', placeholder: 'Ex: History 101' },
                { id: 'section', label: 'Section', type: 'text', placeholder: 'Group A' }
            ],
            create_courseWork: [
                { id: 'courseId', label: 'Target Course', type: 'courseSelect' },
                { id: 'title', label: 'Assignment Title', type: 'text', placeholder: 'Homework 1' },
                { id: 'description', label: 'Instructions', type: 'text', placeholder: 'Read the attached PDF...' },
                { id: 'maxPoints', label: 'Points', type: 'number', value: 100 },
                { id: 'materials', label: 'Attachments (JSON)', type: 'textarea', isJson: true, placeholder: '[]' }
            ],
            create_announcement: [
                { id: 'courseId', label: 'Target Course', type: 'courseSelect' },
                { id: 'text', label: 'Message', type: 'textarea', placeholder: 'Hello students!' }
            ],
            invite_student: [
                { id: 'courseId', label: 'Target Course', type: 'courseSelect' },
                { id: 'email', label: 'Student Email', type: 'email' }
            ],
            list_courseWork: [{ id: 'courseId', label: 'Target Course', type: 'courseSelect' }],
            list_students: [{ id: 'courseId', label: 'Target Course', type: 'courseSelect' }],

            // Default generic schema
            default: [
                { id: 'courseId', label: 'Target Course', type: 'courseSelect' },
                { id: 'id', label: 'Item ID (Optional)', type: 'text' }
            ]
        };

        // EXEMPLES
        const EXAMPLE_MATERIALS = JSON.stringify([
            { "link": { "url": "https://wikipedia.org", "title": "Reference Link" } },
            { "youtubeVideo": { "videoUrl": "https://www.youtube.com/watch?v=dQw4w9WgXcQ", "title": "Educational Video" } }
        ], null, 2);

        // INITIAL LOAD
        window.onload = () => {
            // Auto-load courses if keys are present
            if (document.getElementById('apiUrl').value && document.getElementById('apiKey').value) {
                checkConnectionAndLoadCourses();
            }
        };

        // 1. CARREGAR CURSOS AUTOM√ÄTICAMENT
        async function checkConnectionAndLoadCourses() {
            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;

            connectionStatus.innerHTML = '<span class="text-yellow-500 animate-pulse">üü° Connecting...</span>';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify({ action: 'list_courses', key: key })
                });

                const json = await response.json();

                if (json.error || (json.code && json.code >= 400)) {
                    throw new Error(json.error || "API Error");
                }

                if (Array.isArray(json)) {
                    AVAILABLE_COURSES = json;
                    connectionStatus.innerHTML = `<span class="text-green-400">üü¢ Connected (${json.length} courses loaded)</span>`;

                    // Refresh form if needed to update selectors
                    const currentAction = document.getElementById('actionSelect').value;
                    if (currentAction) document.getElementById('actionSelect').dispatchEvent(new Event('change'));

                    logHistory('System', `Loaded ${json.length} courses`, false);
                } else {
                    throw new Error("Invalid response format");
                }
            } catch (e) {
                console.error(e);
                connectionStatus.innerHTML = '<span class="text-red-500">üî¥ Connection Failed</span>';
                logHistory('System', 'Connection failed. Check URL/Key.', true);
            }
        }

        // 2. GENERADOR DE FORMS
        document.getElementById('actionSelect').addEventListener('change', (e) => {
            const action = e.target.value;
            const fields = SCHEMAS[action] || SCHEMAS.default;

            formContainer.innerHTML = '';

            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = "mb-1";

                const label = document.createElement('label');
                label.className = "block text-[10px] text-slate-400 mb-1 uppercase font-bold ml-1";
                label.innerText = field.label;

                let input;

                // COURSE SELECTOR (Smart Field)
                if (field.type === 'courseSelect') {
                    if (AVAILABLE_COURSES.length > 0) {
                        input = document.createElement('select');
                        input.className = "w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:border-blue-500 focus:outline-none appearance-none";
                        AVAILABLE_COURSES.forEach(course => {
                            const opt = document.createElement('option');
                            opt.value = course.id;
                            opt.innerText = `${course.name} (${course.section || 'No Section'})`;
                            input.appendChild(opt);
                        });
                    } else {
                        // Fallback to text input if no courses loaded
                        input = document.createElement('input');
                        input.type = 'text';
                        input.placeholder = "Enter Course ID (or click Refresh Courses)";
                        input.className = "w-full bg-slate-950 border border-red-900/50 rounded-lg px-3 py-2 text-sm text-slate-200 focus:border-red-500 focus:outline-none";
                    }
                }
                // TEXTAREA (JSON)
                else if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 4;
                    input.className = "w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-xs font-mono text-green-300 focus:border-blue-500 focus:outline-none";

                    if (field.isJson) {
                        const btn = document.createElement('button');
                        btn.innerText = "üìã Use Example Template";
                        btn.className = "text-[10px] text-blue-400 hover:text-blue-300 mb-1 ml-2 underline cursor-pointer";
                        btn.onclick = (ev) => { ev.preventDefault(); input.value = EXAMPLE_MATERIALS; };
                        label.appendChild(btn);
                    }
                }
                // STANDARD INPUT
                else {
                    input = document.createElement('input');
                    input.type = field.type;
                    input.className = "w-full bg-slate-950 border border-slate-700 rounded-lg px-3 py-2 text-sm text-slate-200 focus:border-blue-500 focus:outline-none";
                }

                input.id = `input-${field.id}`;
                if (field.placeholder) input.placeholder = field.placeholder;
                if (field.value) input.value = field.value;

                div.appendChild(label);
                div.appendChild(input);
                formContainer.appendChild(div);
            });
        });

        // 3. EXECUTOR
        async function executeAction() {
            const action = document.getElementById('actionSelect').value;
            if (!action) return;

            const url = document.getElementById('apiUrl').value;
            const key = document.getElementById('apiKey').value;

            const payload = { action: action, key: key };
            const inputs = formContainer.querySelectorAll('input, textarea, select');

            let hasError = false;
            inputs.forEach(input => {
                const key = input.id.replace('input-', '');
                let val = input.value;
                if (input.tagName === 'TEXTAREA' && val.trim().startsWith('[')) {
                    try { val = JSON.parse(val); } catch (e) { alert("Invalid JSON!"); hasError = true; }
                }
                payload[key] = val;
            });

            if (hasError) return;

            // UI
            loader.classList.remove('hidden');
            output.innerHTML = '';
            statusBadge.classList.add('hidden');

            try {
                const startTime = Date.now();
                const response = await fetch(url, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });

                const json = await response.json();
                const duration = Date.now() - startTime;

                loader.classList.add('hidden');
                output.innerHTML = syntaxHighlight(json);

                const isError = json.error || (json.code && json.code >= 400);

                // Badge Status
                statusBadge.innerText = isError ? `ERROR ${json.code || ''}` : `200 OK ‚Ä¢ ${duration}ms`;
                statusBadge.className = isError
                    ? "text-[10px] font-bold px-2 py-0.5 rounded bg-red-900/50 text-red-400 border border-red-900"
                    : "text-[10px] font-bold px-2 py-0.5 rounded bg-green-900/50 text-green-400 border border-green-900";
                statusBadge.classList.remove('hidden');

                logHistory(action, isError ? 'Failed' : 'Success', isError);

                // Reload courses if we just created one
                if (action === 'create_course' && !isError) {
                    checkConnectionAndLoadCourses();
                }

            } catch (err) {
                loader.classList.add('hidden');
                output.innerText = "Network Error: " + err.message;
                logHistory(action, 'Network Error', true);
            }
        }

        // HELPERS
        function logHistory(action, status, isError) {
            const li = document.createElement('li');
            const time = new Date().toLocaleTimeString();
            li.innerHTML = `<span class="text-slate-600">[${time}]</span> <span class="${isError ? 'text-red-400' : 'text-blue-400'}">${action}</span> <span class="text-slate-500">- ${status}</span>`;
            historyList.prepend(li);
        }

        function syntaxHighlight(json) {
            if (typeof json != 'string') json = JSON.stringify(json, undefined, 2);
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                var cls = 'text-yellow-300'; // number
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'text-blue-300'; // key
                    } else {
                        cls = 'text-green-300'; // string
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'text-pink-300'; // boolean
                } else if (/null/.test(match)) {
                    cls = 'text-slate-400'; // null
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
    </script>
</body>

</html>